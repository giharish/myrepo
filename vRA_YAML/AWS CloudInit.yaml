formatVersion: 1
inputs:
  name:
    type: string
    title: Enter machine name
resources:
  Cloud_Machine_1:
    type: Cloud.Machine
    metadata:
      layoutPosition:
        - 0
        - 0
    properties:
      name: '${input.name}'
      image: CloudInit-Win
      flavor: 'tier:medium'
      constraints:
        - tag: aws
      remoteAccess:
        authentication: keyPairName
        keyPair: sql
      cloudConfig: |
        <powershell>
          Start-Transcript -Append C:\PS\aws.log
          Rename-Computer -Newname ${input.name} -Restart
          Install-WindowsFeature -name Web-Server -IncludeManagementTools
          Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
          Start-Process -FilePath C:\SQL\SQL2019\Setup.exe -Args "/Q /ACTION=Install /IACCEPTSQLSERVERLICENSETERMS /FEATURES=SQL,Tools /INSTANCENAME=sqldb /SQLSYSADMINACCOUNTS=pocadmin /SAPWD=VMware1! /TCPENABLED=1 /UPDATEENABLED=FALSE" -Verb RunAs -Wait
        </powershell>
      networks:
        - network: '${resource.Cloud_Network_1.id}'
          assignment: static
          assignPublicIpAddress: true
  Cloud_Network_1:
    type: Cloud.Network
    metadata:
      layoutPosition:
        - 1
        - 0
    properties:
      networkType: existing
      constraints:
        - tag: aws
