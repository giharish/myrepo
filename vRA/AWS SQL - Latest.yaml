formatVersion: 1
inputs:
  name:
    type: string
    title: Enter machine name
resources:
  Cloud_Machine_1:
    type: Cloud.Machine
    metadata:
      layoutPosition:
        - 0
        - 0
    properties:
      name: '${input.name}'
      image: CloudInit-Win
      flavor: 'tier:medium'
      constraints:
        - tag: aws
      cloudConfig: |
        <cloud-config>  
          set_hostname: ${input.name}
        </cloud-config>
        <powershell>
          Start-Transcript -Append C:\PS\aws.log
          Start-Process -FilePath C:\Windows\System32\netdom.exe -Args "renamecomputer $oldname /NewName test1 /Force /Reboot" -Verb RunAs
          Start-Process -FilePath C:\SQL\SQL2019\Setup.exe -Args "/Q /ACTION=Install /IACCEPTSQLSERVERLICENSETERMS /FEATURES=SQL,Tools /INSTANCENAME=sqldb /SQLSYSADMINACCOUNTS=pocadmin /SAPWD=VMware1! /TCPENABLED=1 /UPDATEENABLED=FALSE" -Verb RunAs -Wait
          Start-Process -FilePath "C:\Windows\SysWOW64\wbem\mofcomp.exe" -Args "C:\Program Files (x86)\Microsoft SQL Server\150\Shared\sqlmgmproviderxpsp2up.mof" -Verb RunAs -Wait
        </powershell>
      networks:
        - network: '${resource.Cloud_Network_1.id}'
          assignment: static
          assignPublicIpAddress: true
  Cloud_Network_1:
    type: Cloud.Network
    metadata:
      layoutPosition:
        - 1
        - 0
    properties:
      networkType: existing
      constraints:
        - tag: aws
