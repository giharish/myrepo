formatVersion: 1
inputs:
  MachineName:
    type: string
    title: Name for the VM
    description: This will also be the hostname
  Size:
    type: string
    default: 'medum'
    enum:
      - 'medium'
      - 'large'
  dbinstance:
    type: string
    title: Enter the SQL Database Instance Name
    description: SQL Database Instance Name
  dbpass:
    type: string
    title: Enter the password for SQL Server
    encrypted: true
  username:
    type: string
    title: Enter the Domain User Name in format user@domain
  domain:
    type: string
    title: Domain Name    
resources:
  Cloud_vSphere_Machine_1:
    type: Cloud.vSphere.Machine
    metadata:
      layoutPosition:
        - 0
        - 0
    properties:
      name: '${input.MachineName}'
      image: MSSQL     #Replace with the Image Name
      flavor: '${input.Size}'
      cloudConfig: |
        Content-Type: multipart/mixed; boundary="===123456789"
        MIME-Version: 1.0
        --===123456789
        Content-Type: text/cloud-config; charset="us-ascii"
        MIME-Version: 1.0
        Content-Transfer-Encoding: 7bit
        Content-Disposition: attachment; filename="cloud-config"
        #cloud-config
        runcmd:
          - 'sc config servicename start=auto'
          - 'net start TrustedInstaller'
        set_hostname: ${input.MachineName}
        --===123456789
        Content-Type: text/x-shellscript; charset="us-ascii"
        MIME-Version: 1.0
        Content-Transfer-Encoding: 7bit
        Content-Disposition: attachment; filename="doPsStuff.ps1"
        #ps1_sysnative
        $creds = New-Object System.Management.Automation.PSCredential "${secret.username}",(ConvertTo-SecureString -String "${secret.password}" -AsPlainText -Force)
        Add-Computer -domainName ${input.domain} -Credential $creds -Restart
        --===123456789
        Content-Type: text/x-shellscript; charset="us-ascii"
        MIME-Version: 1.0
        Content-Transfer-Encoding: 7bit
        Content-Disposition: attachment; filename="sqlinstall.ps1"
        #ps1
        Start-Transcript -Append C:\PS\Logs\SQL-Install.log
        Write-Host "Starting Microsoft SQL 2019 Installation"
        Start-Process -FilePath C:\SQL2019\SQL2019\SETUP.EXE -Args "/ACTION=INSTALL /IACCEPTSQLSERVERLICENSETERMS /QUIETSIMPLE /FEATURES=SQL,AS,IS,Tools /INSTANCENAME='${input.dbinstance}' /SQLSVCACCOUNT='${input.username}' /SQLSVCPASSWORD='${input.dbpass}' /SQLSYSADMINACCOUNTS='${input.username}' /SAPWD='${input.dbpass}' /SECURITYMODE=SQL" -Verb RunAs -Wait
        Write-Host "Installing Azure Data Studio"
        Start-Process -FilePath C:\SQL2019\SSMS-Setup-ENU.exe -Args "/QUIET" -Verb RunAs -Wait
        Remove-Item C:\SQL2019 -Recurse
      networks:
        - network: '${resource.Cloud_vSphere_Network_1.id}'
          assignment: static
  Cloud_vSphere_Network_1:
    type: Cloud.vSphere.Network
    metadata:
      layoutPosition:
        - 1
        - 0
    properties:
      networkType: existing
